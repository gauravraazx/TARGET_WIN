<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tasks - CashTarget</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#f6f6f7; --card:#ffffff; --muted:#8b8b8b; --accent:#111111; --radius:18px; --shadow:0 8px 18px rgba(15,15,15,0.06); }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--accent);}
    .app{max-width:480px;margin:auto;padding:14px 14px 96px 14px;}
    .card{background:var(--card);border-radius:var(--radius);padding:22px;margin-bottom:18px;box-shadow:var(--shadow);}

    .header{text-align:center;margin-bottom:24px;}
    .header h1{font-family:"Fredoka One";font-size:32px;margin:0 0 8px 0;}
    .header p{color:var(--muted);margin:0;}

    .task-card{
      background:var(--card);border-radius:14px;padding:18px;margin-bottom:14px;
      box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;
      transition:all .3s;
    }
    .task-card:hover{transform:translateY(-2px);box-shadow:0 12px 24px rgba(15,15,15,0.1);}

    .task-left{flex:1;}
    .task-title{font-weight:700;font-size:16px;margin-bottom:4px;}
    .task-desc{font-size:13px;color:var(--muted);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .task-reward{
      display:inline-block;background:#10b981;color:#fff;padding:4px 12px;
      border-radius:8px;font-size:12px;font-weight:600;
    }
    .task-progress{font-size:12px;color:var(--muted);margin-top:6px;}

    .task-btn{
      padding:12px 24px;border:none;border-radius:12px;
      background:#111;color:#fff;font-weight:700;cursor:pointer;
      transition:all .3s;white-space:nowrap;
    }
    .task-btn:hover{background:#333;transform:scale(1.05);}
    .task-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    
    .task-btn.countdown{
      background:#3b82f6;min-width:80px;
    }
    
    .task-btn.claim{
      background:#10b981;
    }
    .task-btn.claim:hover{background:#059669;}
    
    .task-btn.completed{
      background:#6b7280;cursor:default;
    }
    .task-btn.completed:hover{background:#6b7280;transform:none;}

    .empty-state{
      text-align:center;padding:40px 20px;color:var(--muted);
    }
    .empty-state svg{width:80px;height:80px;margin-bottom:16px;opacity:0.3;}

    .loading{
      text-align:center;padding:40px 20px;color:var(--muted);
    }

    .small-muted{font-size:13px;color:var(--muted);}

    .nav{
      position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:auto;
      background:#000;padding:12px 14px;gap:8px;display:flex;justify-content:space-around;
      z-index:1000;box-shadow:0 -2px 12px rgba(0,0,0,.35);border-top:1px solid #111;
    }
    .nav::before{content:"";position:fixed;left:0;right:0;bottom:0;height:88px;background:#000;z-index:-1;}
    .nav .item{flex:1;color:#fff;text-align:center;text-decoration:none;padding:12px 0;border-radius:16px;background:transparent;transition:all .3s;display:flex;flex-direction:column;align-items:center;gap:0;}
    .nav .item svg{width:26px;height:26px;stroke:currentColor;}
    .nav .item:not(.active):hover{background:rgba(255,255,255,0.08);}
    .nav .item.active{color:#000;font-weight:600;background:#fff;border:1px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>📋 Tasks</h1>
      <p>Complete tasks and earn rewards!</p>
    </div>

    <div id="loadingState" class="loading">
      <div>Loading tasks...</div>
    </div>

    <div id="tasksContainer"></div>

    <div id="emptyState" class="empty-state" style="display:none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 11l3 3L22 4"></path>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
      <div style="font-weight:600;margin-bottom:8px;">No Tasks Available</div>
      <div>Check back later for new tasks!</div>
    </div>
  </div>

  <div class="nav">
    <a href="index.html" class="item" aria-label="Home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </a>
    <a href="about.html" class="item" aria-label="About">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
    </a>
    <a href="profile.html" class="item" aria-label="Profile">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    </a>
    <a href="tasks.html" class="item active" aria-label="Tasks">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
    </a>
    <a href="refer.html" class="item" aria-label="Refer">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
    </a>
    <a href="global.html" class="item" aria-label="Global">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
    </a>
  </div>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// ==================== FIREBASE CONFIG ====================
const firebaseConfig = {
  apiKey: "AIzaSyBJwIzDj6TQWaovZYnYg7YtbNBMWuOP3x0",
  authDomain: "targetwinbot.firebaseapp.com",
  projectId: "targetwinbot",
  storageBucket: "targetwinbot.firebasestorage.app",
  messagingSenderId: "822730504713",
  appId: "1:822730504713:web:30b7cef1dfbcfa375656d8"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// ==================== GLOBAL VARIABLES ====================
let currentUserId = "NOT_APP";
let countdownTimers = {};

// ==================== TELEGRAM USER DETECTION ====================
function getTelegramUser() {
  try {
    const tg = window.Telegram?.WebApp;
    tg?.ready?.();
    const u = tg?.initDataUnsafe?.user;
    if (u?.id) return u;
  } catch {}
  
  try {
    const parse = (src) => {
      const sp = new URLSearchParams(src);
      const raw = sp.get('tgWebAppData') || sp.get('tgwebappdata');
      if (!raw) return null;
      const inner = new URLSearchParams(raw);
      const userStr = inner.get('user');
      return userStr ? JSON.parse(userStr) : null;
    };
    const fromHash = location.hash ? parse(location.hash.slice(1)) : null;
    if (fromHash?.id) return fromHash;
    const fromSearch = parse(location.search.slice(1));
    if (fromSearch?.id) return fromSearch;
  } catch {}
  
  try {
    const cached = localStorage.getItem('last_tg_user');
    if (cached) return JSON.parse(cached);
  } catch {}
  
  return { id: "NOT_APP" };
}

// ==================== INITIALIZE USER ====================
function initUser(){
  const u = getTelegramUser();
  currentUserId = String(u?.id || "NOT_APP");
}

// ==================== TRUNCATE DESCRIPTION ====================
function truncateDescription(desc, wordLimit = 7) {
  const words = desc.trim().split(/\s+/);
  if (words.length > wordLimit) {
    return words.slice(0, wordLimit).join(' ') + '...';
  }
  return desc;
}

// ==================== GET TASK ICON ====================
function getTaskIcon(type) {
  const icons = {
    telegram: '📱',
    twitter: '🐦',
    instagram: '📸',
    youtube: '▶️',
    facebook: '👥',
    other: '🔗'
  };
  return icons[type] || '📋';
}

// ==================== CHECK IF USER COMPLETED TASK ====================
async function isTaskCompleted(taskId) {
  const snap = await get(ref(db, `users/${currentUserId}/completedTasks/${taskId}`));
  return snap.exists();
}

// ==================== START COUNTDOWN ====================
function startCountdown(taskId, button, link) {
  let seconds = 5;
  button.disabled = true;
  button.classList.add('countdown');
  button.textContent = `${seconds}s`;
  
  countdownTimers[taskId] = setInterval(() => {
    seconds--;
    if (seconds > 0) {
      button.textContent = `${seconds}s`;
    } else {
      clearInterval(countdownTimers[taskId]);
      delete countdownTimers[taskId];
      button.textContent = 'CLAIM';
      button.classList.remove('countdown');
      button.classList.add('claim');
      button.disabled = false;
    }
  }, 1000);
}

// ==================== HANDLE JOIN BUTTON ====================
function handleJoin(taskId, taskLink, button) {
  // Open task link in new window
  window.open(taskLink, '_blank');
  
  // Start countdown
  startCountdown(taskId, button, taskLink);
}

// ==================== HANDLE CLAIM BUTTON ====================
async function handleClaim(taskId, rewardAmount, button) {
  button.disabled = true;
  button.textContent = 'Claiming...';
  
  try {
    // Add reward to user's you_watched
    await runTransaction(ref(db, `users/${currentUserId}/you_watched`), (val) => {
      return (val || 0) + rewardAmount;
    });
    
    // Mark task as completed
    await runTransaction(ref(db, `users/${currentUserId}/completedTasks/${taskId}`), () => {
      return true;
    });
    
    // Increment task's completed users count
    await runTransaction(ref(db, `tasks/${taskId}/completedUsers`), (val) => {
      return (val || 0) + 1;
    });
    
    // Update button to completed state
    button.textContent = '✓ Completed';
    button.classList.remove('claim');
    button.classList.add('completed');
    
  } catch (error) {
    console.error('Error claiming reward:', error);
    button.textContent = 'Error';
    setTimeout(() => {
      button.textContent = 'CLAIM';
      button.disabled = false;
    }, 2000);
  }
}

// ==================== RENDER TASKS ====================
async function renderTasks(tasks) {
  const container = document.getElementById('tasksContainer');
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');
  
  loadingState.style.display = 'none';
  
  if (!tasks || Object.keys(tasks).length === 0) {
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  container.innerHTML = '';
  
  for (const [taskId, task] of Object.entries(tasks)) {
    // Skip inactive tasks
    if (task.status !== 'active') continue;
    
    // Skip if max users reached
    if (task.completedUsers >= task.maxUsers) continue;
    
    // Check if user already completed this task
    const completed = await isTaskCompleted(taskId);
    
    // Skip if already completed
    if (completed) continue;
    
    const taskCard = document.createElement('div');
    taskCard.className = 'task-card';
    
    const progressPercent = ((task.completedUsers || 0) / task.maxUsers * 100).toFixed(0);
    const truncatedDesc = truncateDescription(task.description);
    
    taskCard.innerHTML = `
      <div class="task-left">
        <div class="task-title">${task.title}</div>
        <div class="task-desc">${truncatedDesc}</div>
        <span class="task-reward">+${task.rewardAmount} Points</span>
        <div class="task-progress">${task.completedUsers || 0} / ${task.maxUsers} completed (${progressPercent}%)</div>
      </div>
      <button 
        class="task-btn" 
        id="btn-${taskId}"
      >
        JOIN
      </button>
    `;
    
    container.appendChild(taskCard);
    
    // Add event listener to button
    const button = document.getElementById(`btn-${taskId}`);
    let isJoined = false;
    
    button.addEventListener('click', () => {
      if (!isJoined) {
        // First click: JOIN
        handleJoin(taskId, task.link, button);
        isJoined = true;
      } else if (button.classList.contains('claim')) {
        // Second click: CLAIM
        handleClaim(taskId, task.rewardAmount, button);
      }
    });
  }
  
  // Show empty state if no tasks to display
  if (container.children.length === 0) {
    emptyState.style.display = 'block';
  }
}

// ==================== LOAD TASKS ====================
function loadTasks() {
  const tasksRef = ref(db, 'tasks');
  onValue(tasksRef, (snapshot) => {
    const tasks = snapshot.val();
    renderTasks(tasks);
  });
}

// ==================== INITIALIZE APP ====================
initUser();
loadTasks();
</script>
</body>
</html>