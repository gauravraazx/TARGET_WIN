<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CashTarget - Profile</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f6f7; --card:#fff; --muted:#8b8b8b; --accent:#111; --radius:18px; --shadow:0 8px 18px rgba(15,15,15,0.06); }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--accent);}
    .app{max-width:480px;margin:auto;padding:14px 14px 96px 14px;}
    .card{background:var(--card);border-radius:var(--radius);padding:22px;margin-bottom:18px;box-shadow:var(--shadow);}
    .small-muted{font-size:13px;color:var(--muted);}
    .title{font-weight:800;font-size:18px;margin:0 0 10px 0;}

    /* Header: ID left, copy button right */
    .pf-head{display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .pf-left{display:flex;align-items:center;gap:14px;}
    .avatar{width:64px;height:64px;border-radius:50%;background:#f0f0f2;display:flex;align-items:center;justify-content:center;border:2px solid rgba(0,0,0,0.06);}
    .pf-name{font-weight:800;font-size:18px;}
    .pf-sub{color:var(--muted);font-weight:600;}
    .btn{border:none;border-radius:12px;padding:10px 14px;background:#111;color:#fff;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:var(--shadow);}

    /* Stats */
    .grid{display:flex;gap:12px;}
    .stat{flex:1;text-align:center;padding:12px;border-radius:12px;background:#fbfbfb;}
    .k{font-size:12px;color:var(--muted);}
    .v{font-weight:800;font-size:18px;margin-top:6px;}

    /* Balance Box */
    .balance-box{display:flex;align-items:center;justify-content:space-between;margin-top:16px;}
    .balance-info{flex:1;}
    .balance-label{font-size:13px;color:var(--muted);margin-bottom:4px;}
    .balance-amount{font-family:'Fredoka One';font-size:28px;color:#111;}
    .withdraw-btn{border:none;border-radius:12px;padding:12px 20px;background:#111;color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:all .3s;}
    .withdraw-btn:hover{background:#333;}
    .withdraw-btn:disabled{background:#ccc;cursor:not-allowed;}

    /* Modal */
    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:2000;align-items:center;justify-content:center;padding:20px;}
    .modal-overlay.show{display:flex;}
    .modal{background:#fff;border-radius:var(--radius);padding:24px;max-width:400px;width:100%;box-shadow:0 12px 32px rgba(0,0,0,0.2);}
    .modal-title{font-weight:800;font-size:20px;margin:0 0 18px 0;}
    .input-group{margin-bottom:16px;}
    .input-label{font-size:13px;color:var(--muted);margin-bottom:6px;display:block;}
    .input-field{width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:inherit;transition:border .3s;}
    .input-field:focus{outline:none;border-color:#111;}
    .modal-actions{display:flex;gap:10px;margin-top:20px;}
    .modal-btn{flex:1;border:none;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;transition:all .3s;}
    .modal-btn-cancel{background:#f0f0f0;color:#111;}
    .modal-btn-cancel:hover{background:#e0e0e0;}
    .modal-btn-submit{background:#111;color:#fff;}
    .modal-btn-submit:hover{background:#333;}
    .modal-btn-submit:disabled{background:#ccc;cursor:not-allowed;}
    .error-msg{color:#e74c3c;font-size:13px;margin-top:6px;}
    .info-msg{color:var(--muted);font-size:12px;margin-top:4px;}

    /* Win Probability */
    .progress-wrap{background:#eee;border-radius:999px;height:16px;overflow:hidden;}
    .progress{height:100%;width:0;background:linear-gradient(90deg,#111,#666);transition:width .6s;}

    /* Bottom Nav: black, icons only, PROFILE active */
    .nav{
      position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:auto;
      background:#000;padding:12px 14px;gap:8px;display:flex;justify-content:space-around;
      z-index:1000;box-shadow:0 -2px 12px rgba(0,0,0,.35);border-top:1px solid #111;
    }
    .nav::before{content:"";position:fixed;left:0;right:0;bottom:0;height:88px;background:#000;z-index:-1;}
    .nav .item{flex:1;color:#fff;text-align:center;text-decoration:none;padding:12px 0;border-radius:16px;background:transparent;transition:all .3s;display:flex;flex-direction:column;align-items:center;gap:0;}
    .nav .item svg{width:26px;height:26px;stroke:currentColor;}
    .nav .item:not(.active):hover{background:rgba(255,255,255,0.08);}
    .nav .item.active{color:#000;font-weight:600;background:#fff;border:1px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="card">
      <div class="pf-head">
        <div class="pf-left">
          <div class="avatar" aria-hidden="true">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <div>
            <div class="pf-name" id="pfUser">NOT_APP</div>
            <div class="pf-sub">User ID</div>
          </div>
        </div>

        <button class="btn" id="copyBtn" type="button" aria-label="Copy User ID">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
            <rect x="3" y="3" width="13" height="13" rx="2"></rect>
          </svg>
          <span>Copy ID</span>
        </button>
      </div>
      <div class="small-muted" id="copyMsg" style="margin-top:10px;"></div>
    </div>

    <!-- Stats: only you_watched + rank -->
    <div class="card">
      <div class="title">Stats</div>
      <div class="grid">
        <div class="stat">
          <div class="k">Ads Watched</div>
          <div class="v" id="youWatched">0</div>
        </div>
        <div class="stat">
          <div class="k">Global Rank</div>
          <div class="v" id="globalRank">-</div>
        </div>
      </div>

      <!-- Balance & Withdraw -->
      <div class="balance-box">
        <div class="balance-info">
          <div class="balance-label">Your Balance</div>
          <div class="balance-amount">$<span id="balanceAmount">0.00</span></div>
        </div>
        <button class="withdraw-btn" id="withdrawBtn" type="button">Withdraw</button>
      </div>
    </div>

    <!-- Win Probability -->
    <div class="card">
      <div class="title">Win Probability</div>
      <div style="text-align:center">
        <div id="winProb" style="font-family:'Fredoka One';font-size:36px;margin-bottom:6px;">0%</div>
        <div class="small-muted">Rank-based chance</div>
        <div class="progress-wrap" style="margin-top:12px;"><div id="winProgress" class="progress"></div></div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav (PROFILE active) -->
  <div class="nav">
    <a href="index.html" class="item" aria-label="Home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </a>
    <a href="about.html" class="item" aria-label="About">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
    </a>
    <a href="profile.html" class="item active" aria-label="Profile">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
    </a>
    <a href="tasks.html" class="item" aria-label="Tasks">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
    </a>
    <a href="refer.html" class="item" aria-label="Refer">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
    </a>
    <a href="global.html" class="item" aria-label="Global">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
    </a>
  </div>

  <!-- Withdrawal Modal -->
  <div class="modal-overlay" id="withdrawModal">
    <div class="modal">
      <div class="modal-title">Withdraw Funds</div>
      
      <div class="input-group">
        <label class="input-label">Amount (USD)</label>
        <input type="number" class="input-field" id="withdrawAmount" placeholder="Enter amount" step="0.01" min="0.1">
        <div class="info-msg">Minimum withdrawal: $0.10</div>
        <div class="error-msg" id="amountError"></div>
      </div>

      <div class="input-group">
        <label class="input-label">TON Network USDT Address</label>
        <input type="text" class="input-field" id="usdtAddress" placeholder="Enter your USDT address">
        <div class="error-msg" id="addressError"></div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" id="cancelBtn" type="button">Cancel</button>
        <button class="modal-btn modal-btn-submit" id="submitBtn" type="button">Submit Request</button>
      </div>
    </div>
  </div>

  <!-- Logic -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update, onValue, runTransaction, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBJwIzDj6TQWaovZYnYg7YtbNBMWuOP3x0",
    authDomain: "targetwinbot.firebaseapp.com",
    projectId: "targetwinbot",
    storageBucket: "targetwinbot.firebasestorage.app",
    messagingSenderId: "822730504713",
    appId: "1:822730504713:web:30b7cef1dfbcfa375656d8"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const pfUser     = document.getElementById('pfUser');
  const youWatched = document.getElementById('youWatched');
  const globalRank = document.getElementById('globalRank');
  const winProbEl  = document.getElementById('winProb');
  const winProgBar = document.getElementById('winProgress');
  const copyBtn    = document.getElementById('copyBtn');
  const copyMsg    = document.getElementById('copyMsg');
  const balanceAmount = document.getElementById('balanceAmount');
  const withdrawBtn = document.getElementById('withdrawBtn');
  const withdrawModal = document.getElementById('withdrawModal');
  const cancelBtn = document.getElementById('cancelBtn');
  const submitBtn = document.getElementById('submitBtn');
  const withdrawAmount = document.getElementById('withdrawAmount');
  const usdtAddress = document.getElementById('usdtAddress');
  const amountError = document.getElementById('amountError');
  const addressError = document.getElementById('addressError');

  let currentUserId = '';
  let currentBalance = 0;

  function getTelegramUser() {
    try {
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      const u = tg?.initDataUnsafe?.user;
      if (u?.id) return u;
    } catch {}
    try {
      const parse = (src) => {
        const sp = new URLSearchParams(src);
        const raw = sp.get('tgWebAppData') || sp.get('tgwebappdata');
        if (!raw) return null;
        const inner = new URLSearchParams(raw);
        const userStr = inner.get('user');
        return userStr ? JSON.parse(userStr) : null;
      };
      const fromHash = location.hash ? parse(location.hash.slice(1)) : null;
      if (fromHash?.id) return fromHash;
      const fromSearch = parse(location.search.slice(1));
      if (fromSearch?.id) return fromSearch;
    } catch {}
    try {
      const cached = localStorage.getItem('last_tg_user');
      if (cached) return JSON.parse(cached);
    } catch {}
    return { id: "NOT_APP" };
  }

  function probFromRank(rank){
    if (rank === 1) return 100;
    if (rank >= 2 && rank <= 10) return 110 - 10*rank;
    if (rank > 10) return rank <= 100 ? 0.1 : 0.01;
    return 0;
  }

  function computeRankAndWinProb(myId){
    onValue(ref(db, 'users'), async snap=>{
      const users = snap.val() || {};
      const arr = Object.entries(users).map(([id, u])=>({ id, yw: Number(u?.you_watched || 0) }));
      arr.sort((a,b)=> b.yw - a.yw || a.id.localeCompare(b.id));
      const idx = arr.findIndex(x=> x.id === myId);
      const rank = idx === -1 ? arr.length : (idx+1);
      globalRank.textContent = String(rank);
      await update(ref(db, `users/${myId}`), { globalRank: rank });

      const p = probFromRank(rank);
      winProbEl.textContent = p.toString() + "%";
      winProgBar.style.width = Math.min(p,100) + "%";
    });
  }

  // Open/Close Modal
  withdrawBtn.addEventListener('click', () => {
    withdrawModal.classList.add('show');
    withdrawAmount.value = '';
    usdtAddress.value = '';
    amountError.textContent = '';
    addressError.textContent = '';
  });

  cancelBtn.addEventListener('click', () => {
    withdrawModal.classList.remove('show');
  });

  withdrawModal.addEventListener('click', (e) => {
    if (e.target === withdrawModal) {
      withdrawModal.classList.remove('show');
    }
  });

  // Validate and Submit Withdrawal
  submitBtn.addEventListener('click', async () => {
    amountError.textContent = '';
    addressError.textContent = '';
    
    const amount = parseFloat(withdrawAmount.value);
    const address = usdtAddress.value.trim();

    let hasError = false;

    if (!amount || amount < 0.1) {
      amountError.textContent = 'Minimum withdrawal is $0.10';
      hasError = true;
    }

    if (amount > currentBalance) {
      amountError.textContent = 'Insufficient balance';
      hasError = true;
    }

    if (!address) {
      addressError.textContent = 'Please enter your USDT address';
      hasError = true;
    }

    if (hasError) return;

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      // Create withdrawal request
      const withdrawalRef = push(ref(db, 'withdrawals'));
      await update(withdrawalRef, {
        userId: currentUserId,
        amount: amount,
        address: address,
        status: 'pending',
        timestamp: Date.now()
      });

      // Deduct balance
      await runTransaction(ref(db, `users/${currentUserId}/balance`), (bal) => {
        return (bal || 0) - amount;
      });

      alert('Withdrawal request submitted successfully!');
      withdrawModal.classList.remove('show');
    } catch (error) {
      alert('Error processing withdrawal. Please try again.');
      console.error(error);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Request';
    }
  });

  async function initProfile(){
    const u = getTelegramUser();
    const id = String(u?.id || "NOT_APP");
    currentUserId = id;
    pfUser.textContent = id;
    try { if (u?.id && u?.username) localStorage.setItem('last_tg_user', JSON.stringify({id:String(u.id), username:u.username})); } catch {}

    await update(ref(db, `users/${id}`), { lastSeen: Date.now() });
    await runTransaction(ref(db, `users/${id}/you_watched`), v => (v===null||v===undefined)?0:v);
    await runTransaction(ref(db, `users/${id}/balance`), v => (v===null||v===undefined)?0:v);

    const uSnap = await get(ref(db, `users/${id}`));
    const data = uSnap.exists()? uSnap.val() : {};
    youWatched.textContent = Number(data.you_watched || 0);
    currentBalance = Number(data.balance || 0);
    balanceAmount.textContent = currentBalance.toFixed(2);

    onValue(ref(db, `users/${id}/you_watched`), s=>{
      youWatched.textContent = Number(s.val() || 0);
    });

    onValue(ref(db, `users/${id}/balance`), s=>{
      currentBalance = Number(s.val() || 0);
      balanceAmount.textContent = currentBalance.toFixed(2);
      withdrawBtn.disabled = currentBalance < 0.1;
    });

    computeRankAndWinProb(id);

    copyBtn?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(id); copyMsg.textContent = "Copied!"; setTimeout(()=> copyMsg.textContent="", 1200); }
      catch(e){ copyMsg.textContent = "Copy failed"; setTimeout(()=> copyMsg.textContent="", 1200); }
    });
  }

  initProfile();
</script>

</body>
</html>