<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CashTarget - Refer</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f6f6f7; --card:#fff; --muted:#8b8b8b; --accent:#111; --radius:18px; --shadow:0 8px 18px rgba(15,15,15,0.06); }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Inter",sans-serif;background:var(--bg);color:var(--accent);}
    .app{max-width:480px;margin:auto;padding:14px 14px 96px 14px;}
    .card{background:var(--card);border-radius:var(--radius);padding:22px;margin-bottom:18px;box-shadow:var(--shadow);}
    .small-muted{font-size:13px;color:var(--muted);}

    /* Total Invite */
    .amount{font-family:"Fredoka One";font-size:44px;margin:8px 0;text-align:center;}
    .label{color:var(--muted);font-weight:600;text-align:center;}

    /* Link box */
    .linkbox{display:flex;gap:10px;flex-wrap:wrap;}
    .linkinput{
      flex:1; min-width:0; border:2px solid rgba(0,0,0,.08); background:#f7f7f9;
      border-radius:12px; padding:12px; font-weight:600; color:#111;
    }
    .btn{
      border:none;border-radius:12px;padding:12px 14px;background:#111;color:#fff;
      font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:var(--shadow);
    }

    /* Refer list */
    .title{font-weight:800;font-size:18px;margin:0 0 10px 0;}
    .olist{margin:0;padding-left:18px;}
    .olist li{margin:8px 0;word-break:break-all;}

    /* Bottom Nav: black, icons only, REFER active */
    .nav{position:fixed;bottom:0;left:0;right:0;max-width:480px;margin:auto;background:#000;padding:12px 14px;gap:8px;display:flex;justify-content:space-around;z-index:1000;box-shadow:0 -2px 12px rgba(0,0,0,.35);border-top:1px solid #111;}
    .nav::before{content:"";position:fixed;left:0;right:0;bottom:0;height:88px;background:#000;z-index:-1;}
    .nav .item{flex:1;color:#fff;text-decoration:none;padding:12px 0;border-radius:16px;background:transparent;transition:all .3s;display:flex;flex-direction:column;align-items:center;gap:0;}
    .nav .item svg{width:26px;height:26px;stroke:currentColor;}
    .nav .item:not(.active):hover{background:rgba(255,255,255,0.08);}
    .nav .item.active{color:#000;font-weight:600;background:#fff;border:1px solid #fff;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  </style>
</head>
<body>
  <div class="app">

    <!-- TOTAL INVITE -->
    <div class="card" style="text-align:center;border:3px solid rgba(0,0,0,0.05);">
      <div class="label">Total Invite</div>
      <div class="amount" id="totalInvite">0</div>
      <div class="small-muted">Successful referrals linked to this ID</div>
    </div>

    <!-- Invite link -->
    <div class="card">
      <div class="title">Invite Link</div>
      <div class="linkbox">
        <input id="inviteLink" class="linkinput" type="text" readonly value="">
        <button class="btn" id="copyBtn" type="button">Copy Link</button>
        <button class="btn" id="shareBtn" type="button">Share</button>
      </div>
      <div class="small-muted" style="margin-top:10px;">Share this link to get referrals</div>
    </div>

    <!-- Referral list -->
    <div class="card">
      <div class="title">Total Referral</div>
      <ol id="refList" class="olist">
        <!-- 1. {userid} -->
      </ol>
    </div>
  </div>

  <!-- Bottom Nav (REFER active) -->
  <div class="nav">
    <a href="index.html" class="item" aria-label="Home">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    </a>
    <a href="about.html" class="item" aria-label="About">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
    </a>
    <a href="profile.html" class="item" aria-label="Profile">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    </a>
    <a href="refer.html" class="item active" aria-label="Refer">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="9" cy="7" r="4"></circle>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
      </svg>
    </a>
    <a href="global.html" class="item" aria-label="Global">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="2" y1="12" x2="22" y2="12"></line>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
      </svg>
    </a>
  </div>

  <!-- Logic -->
  <!-- Add this before module for WebApp object -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBJwIzDj6TQWaovZYnYg7YtbNBMWuOP3x0",
    authDomain: "targetwinbot.firebaseapp.com",
    projectId: "targetwinbot",
    storageBucket: "targetwinbot.firebasestorage.app",
    messagingSenderId: "822730504713",
    appId: "1:822730504713:web:30b7cef1dfbcfa375656d8"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const totalInviteEl = document.getElementById('totalInvite');
  const inviteLinkEl  = document.getElementById('inviteLink');
  const refListEl     = document.getElementById('refList');
  const copyBtn       = document.getElementById('copyBtn');
  const shareBtn      = document.getElementById('shareBtn');

  const BOT_USERNAME = "Target_Win_Bot";

  // SAME robust helper as index/profile
  function getTelegramUser() {
    try {
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      const u = tg?.initDataUnsafe?.user;
      if (u?.id) return u;
    } catch {}
    try {
      const parse = (src) => {
        const sp = new URLSearchParams(src);
        const raw = sp.get('tgWebAppData') || sp.get('tgwebappdata');
        if (!raw) return null;
        const inner = new URLSearchParams(raw);
        const userStr = inner.get('user');
        return userStr ? JSON.parse(userStr) : null;
      };
      const fromHash = location.hash ? parse(location.hash.slice(1)) : null;
      if (fromHash?.id) return fromHash;
      const fromSearch = parse(location.search.slice(1));
      if (fromSearch?.id) return fromSearch;
    } catch {}
    try {
      const cached = localStorage.getItem('last_tg_user');
      if (cached) return JSON.parse(cached);
    } catch {}
    return { id: "NOT_APP" };
  }

  function setInviteLink(id){
    const link = `https://t.me/${BOT_USERNAME}?start=${id}`;
    inviteLinkEl.value = link;
    return link;
  }

  async function ensureReferNode(id){
    await runTransaction(ref(db, `users/${id}/referid`), (val)=> val || {});
  }

  function renderList(list){
    refListEl.innerHTML = "";
    list.forEach((uid, i)=>{
      const li = document.createElement('li');
      li.textContent = uid;
      refListEl.appendChild(li);
    });
    totalInviteEl.textContent = String(list.length);
  }

  function listenRefers(id){
    onValue(ref(db, `users/${id}/referid`), snap=>{
      const val = snap.val() || {};
      const keys = Array.isArray(val) ? val.filter(Boolean) : Object.keys(val);
      renderList(keys);
    });
  }

  function setupShare(){
    copyBtn.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(inviteLinkEl.value); copyBtn.textContent="Copied!"; setTimeout(()=> copyBtn.textContent="Copy Link", 1200); }
      catch(e){ copyBtn.textContent="Copy failed"; setTimeout(()=> copyBtn.textContent="Copy Link", 1200); }
    });

    shareBtn.addEventListener('click', async ()=>{
      const link = inviteLinkEl.value;
      if (navigator.share){
        try{ await navigator.share({ title: "Join CashTarget", text: "Watch ads and win!", url: link }); }catch{}
      }else{
        try{ await navigator.clipboard.writeText(link); shareBtn.textContent="Link Copied"; setTimeout(()=> shareBtn.textContent="Share", 1200); }
        catch(e){ window.open(link, "_blank"); }
      }
    });
  }

  async function boot(){
    const u = getTelegramUser();
    const id = String(u?.id || "NOT_APP");
    try{ if(u?.id && u?.username) localStorage.setItem('last_tg_user', JSON.stringify({id:String(u.id), username:u.username})); }catch{}

    setInviteLink(id);
    await ensureReferNode(id);
    listenRefers(id);
    setupShare();
  }

  boot();
</script>

</body>
</html>
